#! /usr/bin/env node

const path = require('path');
const spawn = require('child_process').spawn;
const fs = require('fs');
const compareVersions = require('compare-versions');
const chalkSupported = compareVersions(process.version, '10.0') >= 0;
const args = process.argv;

function printError(message) {
    if(chalkSupported){
        const redChalk = require('chalk').red;
        console.error(redChalk(message));
    }
    else {
        console.error(message);
    }
}

function main() {
    const exePath = path.resolve(path.join(path.dirname(__filename), '..', 'bin', 'LocalRunService.dll'));
    if (!fs.existsSync(exePath)) {
        printError(`Error: The file ${exePath} does not exist. There seems an error during the installation.`);
        printError(`Please try 'npm install -g -f azure-streamanalytics-cicd' to reinstall the package.`);
        return;
    }

	console.log(exePath)
    const funcProc = spawn('dotnet', [exePath].concat(args.slice(2)), {
        stdio: [process.stdin, process.stdout, process.stderr, 'pipe']
    });

    funcProc.on('exit', code => {
        process.exit(code);
    });
}

main();
